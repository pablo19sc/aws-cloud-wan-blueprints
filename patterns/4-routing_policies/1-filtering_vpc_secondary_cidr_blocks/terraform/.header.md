# AWS Cloud WAN advanced routing - Filtering VPC secondary CIDR blocks (Terraform)

![Filtering-Secondary-Blocks](../../../../images/patterns_filtering_secondary_cidr_blocks.png)

## Prerequisites
- An AWS account with an IAM user with the appropriate permissions.
- Terraform installed.

## Code Principles:
- Writing DRY (Do No Repeat Yourself) code using a modular design pattern

## Usage
- Clone the repository

```bash
git clone https://github.com/aws-samples/aws-cloud-wan-blueprints.git
```

- Move to the corresponding folder

```bash
cd patterns/4-routing_policies/1-filtering_vpc_secondary_cidr_blocks/terraform
```

- (Optional) Edit the variables.tf file in the project root directory - if you want to test with different parameters.
- Deploy the resources using `terraform apply`.
- **While we include new resources in the Terraform providers**, you will need to attach the `routing-policy-label` to the VPC attachments using the CLI ([put-attachment-routing-policy-label](https://docs.aws.amazon.com/zh_tw/cli/latest/reference/networkmanager/put-attachment-routing-policy-label.html)).

```
CORE_NETWORK_ID=$(terraform output -json cloud_wan | jq -r '.core_network')
VPC_IRELAND_PROD=$(terraform output -json vpcs | jq -r '.ireland.attachment_ids.prod')
VPC_IRELAND_DEV=$(terraform output -json vpcs | jq -r '.ireland.attachment_ids.dev')
VPC_NVIRGINIA_PROD=$(terraform output -json vpcs | jq -r '.nvirginia.attachment_ids.prod')
VPC_NVIRGINIA_DEV=$(terraform output -json vpcs | jq -r '.nvirginia.attachment_ids.dev')

aws networkmanager put-attachment-routing-policy-label --core-network-id $CORE_NETWORK_ID --attachment-id $VPC_IRELAND_PROD --routing-policy-label vpcAttachments --region eu-west-1
aws networkmanager put-attachment-routing-policy-label --core-network-id $CORE_NETWORK_ID --attachment-id $VPC_IRELAND_DEV --routing-policy-label vpcAttachments --region eu-west-1

aws networkmanager put-attachment-routing-policy-label --core-network-id $CORE_NETWORK_ID --attachment-id $VPC_NVIRGINIA_PROD --routing-policy-label vpcAttachments --region us-east-1
aws networkmanager put-attachment-routing-policy-label --core-network-id $CORE_NETWORK_ID --attachment-id $VPC_NVIRGINIA_DEV --routing-policy-label vpcAttachments --region us-east-1
```

- Remember to clean up resoures once you are done by using `terraform destroy`.

**Note** EC2 instances will be deployed in all the Availability Zones configured for each VPC. Keep this in mind when testing this environment from a cost perspective - for production environments, we recommend the use of at least 2 AZs for high-availability.
