# AWS Cloud WAN Route Summarization (Terraform)

![Summarization](../../../../images/patterns_summarization.png)

> **⚠️ Hybrid Environment Required**: This pattern requires you to establish hybrid connectivity (Site-to-Site VPN, Connect attachment, or Direct Connect Gateway) with BGP configuration to test end-to-end. The IaC code creates the Cloud WAN infrastructure, but you must configure your on-premises router to establish BGP sessions.

## Prerequisites

- **AWS Account**: With appropriate IAM permissions
- **Terraform**: >= 1.3.0 installed
- **AWS CLI**: Configured with credentials (required for prefix list association)
- **Permissions required**:
  - Network Manager
  - EC2: VPC, subnets, instances, endpoints, prefix lists
  - IAM: Create roles and policies
- **Hybrid Connectivity**: Site-to-Site VPN, Connect attachment, or Direct Connect Gateway for full testing

## Deployment

```bash
# Clone the repository
git clone https://github.com/aws-samples/aws-cloud-wan-blueprints.git

# Navigate to the Terraform directory
cd patterns/4-routing_policies/7-summarization/terraform

# Initialize Terraform
terraform init

# Deploy the resources
terraform apply
```

> **Important Notes**:
> 1. **Prefix List Association Region**: The prefix list association MUST be created in `us-west-2` as it is Cloud WAN's home region, regardless of where your Core Network edge locations are deployed.
> 2. **Routing Policy Label**: After deployment, when you create your hybrid connections (Site-to-Site VPN, Connect, or Direct Connect Gateway), you MUST add the routing policy label `hybridAttachment` to the attachment for the summarization policy to be applied.
> 3. **Dual-Stack VPCs**: VPCs are deployed as dual-stack (IPv4 and IPv6), but the summarization policy only applies to IPv4 CIDR blocks. IPv6 routes will be advertised without summarization.

## Cleanup

We need first to restore the Core Network policy version to the one with the `base_policy` configuration to remove the prefix list reference. Once this update, we can proceed and remove all the resources at once.

```bash
# Get core network ID
CORE_NETWORK_ID=$(terraform output -json cloud_wan | jq -r '.core_network')

# Restore
aws networkmanager restore-core-network-policy-version \
  --core-network-id $CORE_NETWORK_ID \
  --policy-version-id 1 \
  --region us-west-2

# Check status. Do not proceed to the next command until READY_TO_EXECUTE
aws networkmanager get-core-network-policy \
  --core-network-id $CORE_NETWORK_ID \
  --region us-west-2 \
  --query 'CoreNetworkPolicy.ChangeSetState'

# Execute
aws networkmanager execute-core-network-change-set \
  --core-network-id $CORE_NETWORK_ID \
  --policy-version-id <new-version-from-restore> \
  --region us-west-2

# Check status. Do not proceed to the next command until EXECUTED
aws networkmanager get-core-network-policy \
  --core-network-id $CORE_NETWORK_ID \
  --region us-west-2 \
  --query 'CoreNetworkPolicy.ChangeSetState'

# Destroy all resources
terraform destroy
```

## Next Steps

After successfully deploying this pattern:

1. **Explore the architecture**: Review routing policies and prefix list associations in Network Manager console
2. **Test connectivity**: Establish hybrid connectivity with the `hybridAttachment` routing policy label
3. **Verify summarization**: Check BGP routes advertised to on-premises to confirm summarization is working
4. **Try modifications**: Adjust summary routes, add more prefix lists, test different summarization scenarios
